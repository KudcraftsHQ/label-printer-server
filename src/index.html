<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Label Printer Server</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
            mono: ['SF Mono', 'Monaco', 'monospace']
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaa; }
  </style>
</head>
<body class="bg-zinc-100 font-sans text-zinc-900 h-screen flex flex-col overflow-hidden">

  <!-- Sticky Header -->
  <header class="bg-white border-b border-zinc-200 px-4 py-3 flex-shrink-0">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 bg-indigo-500 rounded-lg flex items-center justify-center text-white font-bold text-lg">P</div>
        <div>
          <h1 class="text-base font-semibold text-zinc-900">Label Printer Server</h1>
          <div class="text-xs text-zinc-400 font-mono" id="api-url">http://localhost:9632</div>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2 text-sm">
          <span class="w-2 h-2 rounded-full bg-emerald-500" id="system-led"></span>
          <span class="text-zinc-600" id="printer-status-header">Connecting...</span>
        </div>
        <span class="text-xs font-mono text-zinc-400" id="app-version">v...</span>
      </div>
    </div>
  </header>

  <!-- Status Bar -->
  <div class="bg-white border-b border-zinc-200 px-4 py-2 flex-shrink-0">
    <div class="flex items-center gap-6 text-sm">
      <div class="flex items-center gap-2">
        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500" id="api-led"></span>
        <span class="text-zinc-600">API</span>
        <span class="font-medium text-emerald-600" id="api-status">Online</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="w-1.5 h-1.5 rounded-full bg-zinc-300" id="printer-led"></span>
        <span class="text-zinc-600">Printer</span>
        <span class="font-medium" id="printer-status">Scanning...</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="text-zinc-600">Queue</span>
        <span class="font-medium text-zinc-700" id="queue-status">-</span>
      </div>
      <button onclick="refreshStatus()" class="ml-auto text-xs text-indigo-600 hover:text-indigo-700 font-medium">Refresh</button>
    </div>
  </div>

  <!-- Main Content - Two Column -->
  <main class="flex-1 overflow-hidden p-4">
    <div class="h-full grid grid-cols-5 gap-4">

      <!-- Left Panel: Print Form -->
      <div class="col-span-3 bg-white rounded-xl border border-zinc-200 shadow-sm flex flex-col overflow-hidden">
        <div class="px-5 py-4 border-b border-zinc-100">
          <h2 class="text-sm font-semibold text-zinc-900 flex items-center gap-2">
            <span class="text-lg">&#128196;</span> Print Label
          </h2>
        </div>
        <div class="flex-1 overflow-y-auto p-5">
          <div class="space-y-4">
            <!-- Config Row -->
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-xs font-medium text-zinc-700 mb-1.5">Page Config</label>
                <select id="test-config" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <option value="default">Default (3x33mm)</option>
                  <option value="single_large">Single Large (60mm)</option>
                  <option value="double">Double (2x40mm)</option>
                  <option value="small_quad">Small Quad (4x25mm)</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-zinc-700 mb-1.5">Layout</label>
                <select id="test-layout" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                  <option value="qr">QR Code</option>
                  <option value="barcode">Barcode</option>
                  <option value="text-only">Text Only</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-zinc-700 mb-1.5">Padding (mm)</label>
                <input type="number" id="test-padding" value="1.5" min="0" max="5" step="0.5" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </div>
            </div>

            <!-- Title -->
            <div>
              <label class="block text-xs font-medium text-zinc-700 mb-1.5">Title</label>
              <input type="text" id="test-title" value="Test Label" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter title...">
            </div>

            <!-- Subtitle -->
            <div>
              <label class="block text-xs font-medium text-zinc-700 mb-1.5">Subtitle <span class="text-zinc-400">(optional)</span></label>
              <input type="text" id="test-subtitle" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter subtitle...">
            </div>

            <!-- Barcode/QR Data -->
            <div>
              <label class="block text-xs font-medium text-zinc-700 mb-1.5">Barcode / QR Data</label>
              <input type="text" id="test-qrdata" value="SKU-12345" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Enter data...">
            </div>

            <!-- Quantity Row -->
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-zinc-700 mb-1.5">Item Qty <span class="text-zinc-400">(on label)</span></label>
                <input type="number" id="test-item-quantity" min="1" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="e.g., 50">
              </div>
              <div>
                <label class="block text-xs font-medium text-zinc-700 mb-1.5">Labels to Print</label>
                <input type="number" id="test-quantity" value="1" min="1" max="100" class="w-full px-3 py-2 text-sm border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </div>
            </div>

            <!-- Print Button -->
            <button onclick="printTest()" id="print-test-btn" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
              <span class="text-lg">&#128424;</span> Print Label
            </button>

            <!-- Result Message -->
            <div id="print-result" class="hidden"></div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Printers -->
      <div class="col-span-2 flex flex-col gap-4 overflow-hidden">

        <!-- Connected Printer -->
        <div class="bg-white rounded-xl border border-zinc-200 shadow-sm flex-shrink-0">
          <div class="px-4 py-3 border-b border-zinc-100">
            <h2 class="text-sm font-semibold text-zinc-900 flex items-center gap-2">
              <span class="text-lg">&#128424;</span> Connected Printer
            </h2>
          </div>
          <div class="p-4">
            <div id="connected-printer-info">
              <div class="text-center py-4 text-zinc-400 text-sm">
                No printer connected
              </div>
            </div>
          </div>
        </div>

        <!-- Available Printers -->
        <div class="bg-white rounded-xl border border-zinc-200 shadow-sm flex-1 flex flex-col overflow-hidden">
          <div class="px-4 py-3 border-b border-zinc-100 flex items-center justify-between flex-shrink-0">
            <h2 class="text-sm font-semibold text-zinc-900">Available Printers</h2>
            <button onclick="loadPrinters()" class="text-xs text-indigo-600 hover:text-indigo-700 font-medium flex items-center gap-1">
              <span>&#128260;</span> Scan
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-3">
            <div id="printer-list" class="space-y-2">
              <div class="text-center py-6 text-zinc-400 text-sm">Scanning...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Collapsible API Reference -->
  <div class="bg-white border-t border-zinc-200 flex-shrink-0">
    <button onclick="toggleApiReference()" class="w-full px-4 py-2 flex items-center justify-between text-sm hover:bg-zinc-50 transition-colors">
      <span class="font-medium text-zinc-700 flex items-center gap-2">
        <span>&#128214;</span> API Reference
      </span>
      <span class="text-zinc-400 transition-transform duration-200" id="api-chevron">&#9660;</span>
    </button>
    <div id="api-content" class="hidden border-t border-zinc-100 px-4 py-3 max-h-48 overflow-y-auto">
      <div class="grid grid-cols-3 gap-2 text-xs">
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-semibold">GET</span>
          <span class="font-mono text-zinc-700">/health</span>
        </div>
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-semibold">GET</span>
          <span class="font-mono text-zinc-700">/printers</span>
        </div>
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded font-semibold">POST</span>
          <span class="font-mono text-zinc-700">/printers/connect</span>
        </div>
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded font-semibold">POST</span>
          <span class="font-mono text-zinc-700">/printers/disconnect</span>
        </div>
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-semibold">GET</span>
          <span class="font-mono text-zinc-700">/printers/status</span>
        </div>
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-semibold">GET</span>
          <span class="font-mono text-zinc-700">/configs</span>
        </div>
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded font-semibold">POST</span>
          <span class="font-mono text-zinc-700">/print</span>
        </div>
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-green-100 text-green-700 rounded font-semibold">POST</span>
          <span class="font-mono text-zinc-700">/print/custom</span>
        </div>
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-semibold">GET</span>
          <span class="font-mono text-zinc-700">/jobs</span>
        </div>
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-red-100 text-red-700 rounded font-semibold">DEL</span>
          <span class="font-mono text-zinc-700">/jobs/:id</span>
        </div>
        <div class="flex items-center gap-2 py-1">
          <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-semibold">GET</span>
          <span class="font-mono text-zinc-700">/queue/stats</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    let apiPort = 9632;
    let connectedPrinter = null;
    let availablePrinters = [];
    let isWindowsServer = false;

    function toHex(num) {
      return '0x' + num.toString(16).toUpperCase().padStart(4, '0');
    }

    function toggleApiReference() {
      const content = document.getElementById('api-content');
      const chevron = document.getElementById('api-chevron');
      content.classList.toggle('hidden');
      chevron.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
    }

    function updateConnectedPrinterUI() {
      const container = document.getElementById('connected-printer-info');
      const printerLed = document.getElementById('printer-led');
      const printerStatus = document.getElementById('printer-status');
      const headerStatus = document.getElementById('printer-status-header');

      if (connectedPrinter) {
        printerLed.className = 'w-1.5 h-1.5 rounded-full bg-emerald-500';
        printerStatus.textContent = 'Ready';
        printerStatus.className = 'font-medium text-emerald-600';

        const name = connectedPrinter.name || connectedPrinter.product || 'Unknown';
        headerStatus.textContent = name;

        const isWindows = !!connectedPrinter.name && !connectedPrinter.vendorId;

        container.innerHTML = `
          <div class="flex items-start justify-between mb-3">
            <div>
              <div class="font-medium text-zinc-900">${name}</div>
              <div class="text-xs text-zinc-500">${isWindows ? 'Windows Printer' : (connectedPrinter.manufacturer || 'USB Printer')}</div>
            </div>
            <span class="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-semibold rounded">Active</span>
          </div>
          <div class="grid grid-cols-2 gap-2 text-xs mb-3">
            ${isWindows ? `
              <div><span class="text-zinc-500">Driver:</span> <span class="font-mono">${connectedPrinter.driver || 'N/A'}</span></div>
              <div><span class="text-zinc-500">Port:</span> <span class="font-mono">${connectedPrinter.portName || 'N/A'}</span></div>
            ` : `
              <div><span class="text-zinc-500">VID:</span> <span class="font-mono">${toHex(connectedPrinter.vendorId)}</span></div>
              <div><span class="text-zinc-500">PID:</span> <span class="font-mono">${toHex(connectedPrinter.productId)}</span></div>
            `}
          </div>
          <button onclick="disconnectPrinter()" class="w-full py-1.5 text-xs font-medium text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition-colors">
            Disconnect
          </button>
        `;
      } else {
        printerLed.className = 'w-1.5 h-1.5 rounded-full bg-zinc-300';
        printerStatus.textContent = 'Disconnected';
        printerStatus.className = 'font-medium text-zinc-500';
        headerStatus.textContent = 'No printer';

        container.innerHTML = `
          <div class="text-center py-4 text-zinc-400 text-sm">
            No printer connected
          </div>
        `;
      }
    }

    async function refreshStatus() {
      try {
        document.getElementById('api-url').textContent = `http://localhost:${apiPort}`;

        const healthResponse = await fetch(`http://localhost:${apiPort}/health`);
        const health = await healthResponse.json();

        const systemLed = document.getElementById('system-led');
        const apiLed = document.getElementById('api-led');
        const apiStatus = document.getElementById('api-status');

        systemLed.className = 'w-2 h-2 rounded-full bg-emerald-500';
        apiLed.className = 'w-1.5 h-1.5 rounded-full bg-emerald-500';
        apiStatus.textContent = 'Online';
        apiStatus.className = 'font-medium text-emerald-600';

        if (health.printer.connected) {
          const statusResponse = await fetch(`http://localhost:${apiPort}/printers/status`);
          const statusData = await statusResponse.json();

          if (statusData.success && statusData.status.device) {
            const device = statusData.status.device;
            // Merge with printer info from available list
            const printerInfo = device.name
              ? availablePrinters.find(p => p.name === device.name)
              : availablePrinters.find(p => p.vendorId === device.vendorId && p.productId === device.productId);

            connectedPrinter = { ...device, ...printerInfo };
          }
        } else {
          connectedPrinter = null;
        }

        updateConnectedPrinterUI();

        const queueStats = health.queue;
        document.getElementById('queue-status').textContent =
          `${queueStats.pending} pending, ${queueStats.processing} active`;

        renderPrinterList();

      } catch (error) {
        console.error('Error fetching status:', error);
        document.getElementById('system-led').className = 'w-2 h-2 rounded-full bg-red-500';
        document.getElementById('api-led').className = 'w-1.5 h-1.5 rounded-full bg-red-500';
        document.getElementById('api-status').textContent = 'Offline';
        document.getElementById('api-status').className = 'font-medium text-red-600';
        document.getElementById('printer-status-header').textContent = 'Offline';
      }
    }

    async function loadPrinters() {
      const listDiv = document.getElementById('printer-list');
      listDiv.innerHTML = '<div class="text-center py-6 text-zinc-400 text-sm">Scanning...</div>';

      try {
        const response = await fetch(`http://localhost:${apiPort}/printers`);
        const data = await response.json();

        if (data.success) {
          availablePrinters = data.printers;
          isWindowsServer = data.isWindows || false;
          renderPrinterList();
        } else {
          listDiv.innerHTML = '<div class="text-center py-6 text-red-400 text-sm">Error loading</div>';
        }
      } catch (error) {
        console.error('Error loading printers:', error);
        listDiv.innerHTML = '<div class="text-center py-6 text-red-400 text-sm">Scan failed</div>';
      }
    }

    function renderPrinterList() {
      const listDiv = document.getElementById('printer-list');

      if (availablePrinters.length === 0) {
        listDiv.innerHTML = `<div class="text-center py-6 text-zinc-400 text-sm">No printers found</div>`;
        return;
      }

      // Sort printers: connected printer first
      const sortedPrinters = [...availablePrinters].sort((a, b) => {
        const aConnected = isWindowsServer
          ? (connectedPrinter && connectedPrinter.name === a.name)
          : (connectedPrinter && connectedPrinter.vendorId === a.vendorId && connectedPrinter.productId === a.productId);
        const bConnected = isWindowsServer
          ? (connectedPrinter && connectedPrinter.name === b.name)
          : (connectedPrinter && connectedPrinter.vendorId === b.vendorId && connectedPrinter.productId === b.productId);
        if (aConnected && !bConnected) return -1;
        if (!aConnected && bConnected) return 1;
        return 0;
      });

      listDiv.innerHTML = sortedPrinters.map(printer => {
        const isConnected = isWindowsServer
          ? (connectedPrinter && connectedPrinter.name === printer.name)
          : (connectedPrinter && connectedPrinter.vendorId === printer.vendorId && connectedPrinter.productId === printer.productId);

        const name = printer.name || printer.product || 'Unknown Device';
        const subtitle = isWindowsServer ? (printer.manufacturer || 'Windows') : (printer.manufacturer || 'USB');
        const id = isWindowsServer ? (printer.portName || '') : toHex(printer.vendorId);

        const connectAction = isWindowsServer
          ? `connectPrinter(null, null, '${printer.name.replace(/'/g, "\\'")}')`
          : `connectPrinter(${printer.vendorId}, ${printer.productId})`;

        return `
          <div class="p-3 border rounded-lg ${isConnected ? 'border-emerald-300 bg-emerald-50' : 'border-zinc-200 hover:border-indigo-300'} transition-colors">
            <div class="flex items-center justify-between">
              <div class="min-w-0 flex-1">
                <div class="font-medium text-sm text-zinc-900 truncate">${name}</div>
                <div class="text-xs text-zinc-500">${subtitle} Â· ${id}</div>
              </div>
              ${isConnected
                ? '<span class="px-2 py-1 bg-emerald-500 text-white text-xs font-medium rounded">Active</span>'
                : `<button onclick="${connectAction}" class="px-2 py-1 text-xs font-medium text-indigo-600 border border-indigo-200 rounded hover:bg-indigo-50 transition-colors">Connect</button>`
              }
            </div>
          </div>
        `;
      }).join('');
    }

    async function connectPrinter(vendorId, productId, name) {
      try {
        const payload = isWindowsServer ? { name } : { vendorId, productId };

        const response = await fetch(`http://localhost:${apiPort}/printers/connect`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.success) {
          await refreshStatus();
        } else {
          alert('Connection failed: ' + data.error);
        }
      } catch (error) {
        console.error('Error connecting to printer:', error);
        alert('Connection error');
      }
    }

    async function disconnectPrinter() {
      try {
        const response = await fetch(`http://localhost:${apiPort}/printers/disconnect`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          connectedPrinter = null;
          await refreshStatus();
        } else {
          alert('Disconnect failed: ' + data.error);
        }
      } catch (error) {
        console.error('Error disconnecting from printer:', error);
        alert('Disconnect error');
      }
    }

    async function printTest() {
      const resultDiv = document.getElementById('print-result');
      const btn = document.getElementById('print-test-btn');

      if (!connectedPrinter) {
        resultDiv.className = 'p-3 bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg text-center';
        resultDiv.textContent = 'Please connect to a printer first';
        resultDiv.classList.remove('hidden');
        return;
      }

      const pageConfig = document.getElementById('test-config').value;
      const layout = document.getElementById('test-layout').value;
      const padding = parseFloat(document.getElementById('test-padding').value) || 1.5;
      const title = document.getElementById('test-title').value;
      const subtitle = document.getElementById('test-subtitle').value;
      const barcodeData = document.getElementById('test-qrdata').value;
      const itemQuantity = document.getElementById('test-item-quantity').value;
      const quantity = parseInt(document.getElementById('test-quantity').value) || 1;

      if (!title) {
        resultDiv.className = 'p-3 bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg text-center';
        resultDiv.textContent = 'Title is required';
        resultDiv.classList.remove('hidden');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="animate-pulse">Printing...</span>';

      try {
        const response = await fetch(`http://localhost:${apiPort}/print`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pageConfig,
            padding,
            label: {
              title,
              subtitle: subtitle || undefined,
              barcodeData: barcodeData || undefined,
              qrData: barcodeData || undefined,
              itemQuantity: itemQuantity ? parseInt(itemQuantity) : undefined,
              layout
            },
            quantity
          })
        });

        const data = await response.json();
        resultDiv.classList.remove('hidden');

        if (data.success) {
          resultDiv.className = 'p-3 bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm rounded-lg text-center';
          resultDiv.textContent = `Queued successfully (ID: ${data.job.id})`;
          await refreshStatus();
        } else {
          resultDiv.className = 'p-3 bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg text-center';
          resultDiv.textContent = 'Failed: ' + data.error;
        }
      } catch (error) {
        console.error('Error printing:', error);
        resultDiv.classList.remove('hidden');
        resultDiv.className = 'p-3 bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg text-center';
        resultDiv.textContent = 'Error sending print job';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="text-lg">&#128424;</span> Print Label';
      }
    }

    async function loadVersion() {
      try {
        const response = await fetch(`http://localhost:${apiPort}/`);
        const data = await response.json();
        document.getElementById('app-version').textContent = `v${data.version}`;
      } catch (e) {
        document.getElementById('app-version').textContent = 'v?';
      }
    }

    // Initial load
    setTimeout(() => {
      loadPrinters();
      refreshStatus();
      loadVersion();
    }, 500);

    // Auto-refresh every 5 seconds
    setInterval(refreshStatus, 5000);
  </script>
</body>
</html>
